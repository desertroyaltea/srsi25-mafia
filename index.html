// netlify/functions/get-game-state.js

const { google } = require('googleapis');
const { JWT } = require('google-auth-library');

// Helper function to initialize Google Sheets API
async function getSheetsService() {
    const credentials = JSON.parse(process.env.GOOGLE_SERVICE_ACCOUNT_CREDENTIALS);
    const auth = new JWT({
        email: credentials.client_email,
        key: credentials.private_key,
        scopes: ['https://www.googleapis.com/auth/spreadsheets.readonly']
    });
    return google.sheets({ version: 'v4', auth });
}

exports.handler = async (event, context) => {
    const sheetId = process.env.GOOGLE_SHEET_ID;
    if (!sheetId) {
        console.error("get-game-state: Google Sheet ID is not configured.");
        return { statusCode: 500, body: JSON.stringify({ error: 'Server configuration error.' }) };
    }

    try {
        const sheets = await getSheetsService();

        // 1. Calculate the correct current day number based on the real-world date
        const startDate = new Date('2024-07-24T00:00:00');
        const today = new Date();
        const todaySA = new Date(today.toLocaleString('en-US', { timeZone: 'Asia/Riyadh' }));
        const timeDiff = todaySA.getTime() - startDate.getTime();
        const currentDayNumber = Math.floor(timeDiff / (1000 * 3600 * 24)) + 1;
        console.log(`Calculated current day is: ${currentDayNumber}`);

        // 2. Fetch all rows from the Game_State sheet
        const response = await sheets.spreadsheets.values.get({
            spreadsheetId: sheetId,
            range: 'Game_State!A:G',
        });

        const allRows = response.data.values || [];
        if (allRows.length < 2) {
            throw new Error("Game_State sheet is empty or has no data.");
        }

        const headers = allRows[0];
        const dataRows = allRows.slice(1);
        const dayColIndex = headers.indexOf('CurrentDay');

        // 3. Find the most recent row that matches the calculated current day
        let latestMatchingRow = null;
        for (let i = dataRows.length - 1; i >= 0; i--) {
            const row = dataRows[i];
            if (row[dayColIndex] && row[dayColIndex].toString() === currentDayNumber.toString()) {
                latestMatchingRow = row;
                break; // Stop searching once the latest entry for today is found
            }
        }

        if (!latestMatchingRow) {
             // Fallback: If no entry for today is found, use the very last row in the sheet
            latestMatchingRow = dataRows[dataRows.length - 1];
            console.warn(`No entry found for Day ${currentDayNumber}. Falling back to the last available row.`);
        }

        // 4. Parse the correct row into a game state object
        const gameState = {};
        headers.forEach((header, index) => {
            const cleanHeader = header.replace(/[^a-zA-Z0-9]/g, '');
            gameState[cleanHeader] = latestMatchingRow[index] || null;
        });
        
        console.log('Parsed game state object from correct row:', gameState);

        return {
            statusCode: 200,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(gameState),
        };

    } catch (error) {
        console.error('Error in get-game-state function:', error);
        return {
            statusCode: 500,
            body: JSON.stringify({ error: 'Failed to fetch game state.', details: error.message }),
        };
    }
};
