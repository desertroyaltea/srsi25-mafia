<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRSI Mafia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Times New Roman", Times, serif;
            background-color: #000000;
            color: #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            background-image: url('https://img.freepik.com/free-vector/red-blood-splatter-black-background-ideal-halloween_1048-19440.jpg?semt=ais_hybrid&w=740');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
        }
        .container {
            background-color: rgba(15, 15, 15, 0.9);
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(255, 0, 0, 0.4);
            width: 100%;
            max-width: 960px;
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.8rem;
            border: 1px solid rgba(255, 0, 0, 0.3);
            backdrop-filter: blur(2px);
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4a5568;
            color: #e2e8f0;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            color: white;
            font-size: 1.8rem;
            flex-direction: column;
            gap: 1rem;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%23a0aec0' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        input, select {
            background-color: #333333;
            border: 1px solid #555555;
            color: #e2e8f0;
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        Loading SRSI Mafia...
    </div>

    <div id="app-root"></div>
    <div id="message-box" class="message-box"></div>

<script type="module">
const state = { allPlayers: [], currentUserId: null, currentUser: null, isCurrentUserAdmin: false, gameState: null, pendingAccusations: [], currentTrial: null, currentMission: null, nightlyRecap: null };    
    const appRoot = document.getElementById('app-root');
    const messageBox = document.getElementById('message-box');
    const loadingOverlay = document.getElementById('loading-overlay');
    let mediaRecorder;
    let audioChunks = [];
    let recordedAudioBlob = null;
    let audioPlayer;

    const templates = {
login: () => `
Â  Â  Â  Â  Â  Â  <div class="container">
Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-4xl font-bold text-center text-red-500 mb-6">SRSI MAFIA LOGIN</h1>
Â  Â  Â  Â  Â  Â  Â  Â  <form id="login-form">
                    <div class="mb-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="passcode-input" class="block text-gray-300 text-lg font-bold mb-2">Enter Your Passcode:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="passcode-input" class="shadow appearance-none border rounded w-full py-3 px-4 text-lg text-gray-200 leading-tight focus:outline-none focus:shadow-outline" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-6 rounded-lg w-full text-xl">Enter Game</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="login-error" class="text-red-500 text-center mt-4"></p>
Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  </div>`,
gameLayout: (viewHtml) => `
Â  Â  Â  Â  Â  Â  <div class="container" id="game-container">
Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-4xl font-bold text-center text-red-500 mb-2">ðŸ©¸SRSI MafiaðŸ”«</h1>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-400 text-center mb-6">Made by: Abdulelah AlHarbi | EXCOR 23'24'</p>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-gray-900 p-4 rounded-lg flex justify-between items-center mb-4"> <!-- Added mb-4 -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-base text-gray-400">Logged in as:</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-mono text-blue-400 text-base">${state.currentUser.Name} (${state.currentUser.Role})</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
                <!-- NEW UNIVERSAL LOGOUT BUTTON -->
                <button type="button" id="logout-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg w-full mb-6">
                    Logout
                </button>
                <!-- END NEW UNIVERSAL LOGOUT BUTTON -->
Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 gap-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-gray-900 p-5 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-semibold mb-3">Game Status</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Current Day: <span class="font-bold text-red-400">${state.gameState?.CurrentDay || '...'}</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Current Phase: <span class="font-bold text-red-400">${state.gameState?.CurrentPhase || '...'}</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- The Trial Information div has been removed -->
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="view-content">${viewHtml}</div>
Â  Â  Â  Â  Â  Â  </div>`,
dashboard: () => `
Â  Â  Â  Â  Â  Â  <div class="bg-gray-900 p-5 rounded-lg mt-4">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-semibold mb-4">Dashboard</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-400 mb-6">Select an action to proceed.</p>

                 <!-- CURRENT MISSION SECTION -->
                 <div class="bg-gray-800 p-4 rounded-lg mb-6 border border-gray-700">
                     <h3 class="text-xl font-semibold text-yellow-400 mb-2">Current Mission:</h3>
                     ${state.currentMission ? `
                         <p class="text-gray-300">${state.currentMission.MissionDescription}</p>
                     ` : `
                         <p class="text-gray-400">No active mission assigned.</p>
                     `}
                 </div>
                 <!-- END CURRENT MISSION SECTION -->

                 <!-- NEW NIGHTLY RECAP SECTION -->
                 ${state.gameState?.CurrentPhase === 'Day' && state.nightlyRecap ? `
                     <div class="bg-gray-800 p-4 rounded-lg mb-6 border border-gray-700">
                         <h3 class="text-xl font-semibold text-red-400 mb-2">Last Night's Story:</h3>
                         <div id="nightly-recap-story" class="text-gray-300 leading-relaxed">
                             <!-- Story will be generated here by JavaScript -->
                         </div>
                     </div>
                 ` : ''}
                 <!-- END NEW NIGHTLY RECAP SECTION -->

Â  Â  Â  Â  Â  Â  Â  Â  <div id="player-dashboard-actions" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="admin-dashboard-actions" class="grid-cols-1 md:grid-cols-2 gap-4 ${state.isCurrentUserAdmin ? 'grid' : 'hidden'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btn-review-accusations" class="bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg">Review Accusations</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>`,
        actionModal: ({ title, buttonText, targets, actionType }) => `
            <div class="bg-gray-900 p-5 rounded-lg mt-4">
                <h2 class="text-2xl font-semibold mb-4 text-red-400">${title}</h2>
                <form id="action-form" data-action-type="${actionType}">
                    <div class="mb-4">
                        <label for="target-player" class="block text-gray-300 text-lg font-bold mb-2">Select Target:</label>
                        <select id="target-player" class="shadow border rounded w-full py-3 px-4 text-lg leading-tight focus:outline-none focus:shadow-outline bg-gray-700 border-gray-600 text-white" required>
                            <option value="">-- Select a player --</option>
                            ${targets.map(p => `<option value="${p.PlayerID}">${p.Name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex flex-col md:flex-row gap-4">
                        <button type="submit" class="bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-6 rounded-lg w-full md:w-1/2 text-xl">
                            ${buttonText}
                        </button>
                        <button type="button" id="back-to-dashboard" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg w-full md:w-1/2 text-xl">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        `,
        accusationForm: ({ targets }) => `
            <div class="bg-gray-900 p-5 rounded-lg mt-4">
                <h2 class="text-2xl font-semibold mb-4 text-red-400">Submit Accusation</h2>
                <form id="accusation-submission-form">
                    <div class="mb-4">
                        <label for="accuser-name" class="block text-gray-300 text-lg font-bold mb-2">Accuser (Your Name):</label>
                        <input type="text" id="accuser-name" class="shadow appearance-none border rounded w-full py-3 px-4 text-lg text-gray-200 leading-tight focus:outline-none focus:shadow-outline bg-gray-700 border-gray-600 cursor-not-allowed" value="${state.currentUser.Name}" readonly>
                    </div>
                    <div class="mb-4">
                        <label for="accused-player-select" class="block text-gray-300 text-lg font-bold mb-2">Accused Player:</label>
                        <select id="accused-player-select" class="shadow border rounded w-full py-3 px-4 text-lg leading-tight focus:outline-none focus:shadow-outline bg-gray-700 border-gray-600 text-white" required>
                            <option value="">-- Select accused player --</option>
                            ${targets.map(p => `<option value="${p.PlayerID}">${p.Name}</option>`).join('')}
                        </select>
                    </div>

                    <div class="mb-6">
                        <label class="block text-gray-300 text-lg font-bold mb-2">Record Accusation:</label>
                        <div class="flex flex-wrap items-center gap-4 mb-4">
                            <button type="button" id="start-recording" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Start Recording</button>
                            <button type="button" id="stop-recording" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg" disabled>Stop Recording</button>
                        </div>
                        <audio id="audio-playback" controls class="w-full hidden"></audio>
                    </div>

                    <div class="flex flex-col md:flex-row gap-4">
                        <button type="submit" id="submit-accusation-btn" class="bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-6 rounded-lg w-full md:w-1/2 text-xl" disabled>Submit Accusation</button>
                        <button type="button" id="back-to-dashboard" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg w-full md:w-1/2 text-xl">Cancel</button>
                    </div>
                </form>
            </div>
        `,
        adminReview: ({ pendingAccusations }) => `
            <div class="bg-gray-900 p-5 rounded-lg mt-4">
                <h2 class="text-2xl font-semibold mb-4 text-red-400">Admin Review: Pending Accusations</h2>
                ${pendingAccusations.length > 0 ? `
                    <div class="space-y-6">
                        ${pendingAccusations.map(acc => `
                            <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                                <p class="text-gray-300"><strong>Accusation ID:</strong> ${acc.AccusationID}</p>
                                <p class="text-gray-300"><strong>Accuser:</strong> ${getPlayerNameById(acc.AccuserPlayerID)}</p>
                                <p class="text-gray-300"><strong>Accused:</strong> ${getPlayerNameById(acc.AccusedPlayerID)}</p>
                                <p class="text-gray-300"><strong>Submitted:</strong> ${new Date(acc.SubmissionTime).toLocaleString()}</p>
                                <div class="mt-3 mb-4">
                                    <label class="block text-gray-400 text-sm font-bold mb-2">Audio:</label>
                                    <audio controls class="w-full">
                                        <source src="${acc.AudioDriveLink}" type="audio/webm">
                                        <source src="${acc.AudioDriveLink}" type="audio/mp4">
                                        Your browser does not support the audio element.
                                    </audio>
                                </div>
                                <div class="flex flex-col md:flex-row gap-2">
                                    <button type="button" class="btn-approve-accusation bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-lg w-full" data-accusation-id="${acc.AccusationID}">Approve</button>
                                    <button type="button" class="btn-deny-accusation bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg w-full" data-accusation-id="${acc.AccusationID}">Deny</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : '<p class="text-gray-400">No pending accusations to review.</p>'}
                <button type="button" id="back-to-dashboard" class="mt-6 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg w-full">Back to Dashboard</button>
            </div>
        `,

// NEW DEAD PAGE TEMPLATE
            deadPage: () => `
                <div class="bg-gray-900 p-5 rounded-lg mt-4 text-center">
                    <h2 class="text-4xl font-bold text-red-700 mb-6">YOU ARE DEAD.</h2>
                    <p class="text-xl text-gray-300 mb-4">
                        Your journey in the SRSI Mafia game has come to an end.
                        The shadows have claimed you.
                    </p>
                    <p class="text-2xl font-bold text-red-500 mb-6">
                        Rest in Pieces.
                    </p>
                    <p class="text-lg text-gray-400">
                        You can no longer participate in game actions.
                        Wait for the final verdict of the living.
                    </p>
                </div>
            `,

// NEW TRIAL PAGE TEMPLATE
            trialPage: ({ trial }) => `
                <div class="bg-gray-900 p-5 rounded-lg mt-4">
                    <h2 class="text-3xl font-bold text-red-400 mb-4 text-center">The Trial</h2>
                    ${trial ? `
                        <div class="space-y-4">
                            <p class="text-lg text-gray-300"><strong>Accused:</strong> ${getPlayerNameById(trial.AccusedPlayerID)}</p>
                            <div class="mt-3 mb-4">
                                <label class="block text-gray-400 text-sm font-bold mb-2">Accusation Audio:</label>
                                <audio controls class="w-full">
                                    <source src="${trial.AccusationAudioLink}" type="audio/webm">
                                    <source src="${trial.AccusationAudioLink}" type="audio/mp4">
                                    Your browser does not support the audio element.
                                </audio>
                            </div>
                            <p class="text-sm text-gray-400">Trial started: ${new Date(trial.TrialStartTime).toLocaleString()}</p>
                            <p class="text-sm text-gray-400">Voting deadline: ${new Date(trial.VotingDeadline).toLocaleString()}</p>
                            <p class="text-sm text-gray-400">Your current voting power: <span class="font-bold text-blue-400">${state.currentUser.CurrentVotingPower || 1}</span></p>
                        </div>
                        <div class="flex flex-col md:flex-row gap-4 mt-6">
                            <button type="button" id="btn-vote-guilty" class="bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-6 rounded-lg w-full md:w-1/2 text-xl" data-trial-id="${trial.TrialID}">GUILTY</button>
                            <button type="button" id="btn-vote-not-guilty" class="bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 px-6 rounded-lg w-full md:w-1/2 text-xl" data-trial-id="${trial.TrialID}">NOT GUILTY</button>
                        </div>
                    ` : '<p class="text-gray-400 text-center">No active trial to display.</p>'}
                    <button type="button" id="back-to-dashboard" class="mt-6 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg w-full">Back to Dashboard</button>
                </div>
            `,

// NEW INVESTIGATION HISTORY TEMPLATE
            investigationHistory: ({ history }) => `
                <div class="bg-gray-900 p-5 rounded-lg mt-4">
                    <h2 class="text-2xl font-semibold mb-4 text-purple-400">Investigation History</h2>
                    ${history && history.length > 0 ? `
                        <ul class="list-disc list-inside space-y-2">
                            ${history.split(',').map(entry => {
                                const [playerId, isMafia] = entry.split(':');
                                const playerName = getPlayerNameById(playerId);
                                return `<li>${playerName} (${playerId}): ${isMafia === 'YES' ? 'Is Mafia' : 'Not Mafia'}</li>`;
                            }).join('')}
                        </ul>
                    ` : '<p class="text-gray-400">No investigations logged yet.</p>'}
                    <button type="button" id="back-to-dashboard" class="mt-6 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg w-full">Back to Dashboard</button>
                </div>
            `,

// NEW CHANGE ROLE MODAL TEMPLATE
            changeRoleModal: () => `
                <div class="bg-gray-900 p-5 rounded-lg mt-4">
                    <h2 class="text-2xl font-semibold mb-4 text-green-400">Change Your Role</h2>
                    <p class="text-gray-300 mb-6">Choose your new role:</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button type="button" class="btn-select-new-role bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-6 rounded-lg text-xl" data-new-role="Mafia">Mafia</button>
                        <button type="button" class="btn-select-new-role bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 px-6 rounded-lg text-xl" data-new-role="Detective">Detective</button>
                        <button type="button" class="btn-select-new-role bg-yellow-700 hover:bg-yellow-800 text-white font-bold py-3 px-6 rounded-lg text-xl" data-new-role="Doctor">Doctor</button>
                    </div>
                    <button type="button" id="back-to-dashboard" class="mt-6 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg w-full">Cancel</button>
                </div>
            `,

// NEW INVESTIGATION RESULT TEMPLATE
            investigationResult: ({ targetName, isMafiaResult }) => `
                <div class="bg-gray-900 p-5 rounded-lg mt-4 text-center">
                    <h2 class="text-3xl font-bold mb-4 ${isMafiaResult === 'YES' ? 'text-red-500' : 'text-green-500'}">Investigation Result</h2>
                    <p class="text-xl text-gray-300 mb-4">
                        Your investigation of <span class="font-bold text-blue-400">${targetName}</span> reveals:
                    </p>
                    ${isMafiaResult === 'YES' ? `
                        <p class="text-4xl font-bold text-red-500 mb-6">MAFIA!</p>
                        <p class="text-lg text-gray-400">Proceed with caution.</p>
                    ` : `
                        <p class="text-4xl font-bold text-green-500 mb-6">NOT MAFIA.</p>
                        <p class="text-lg text-gray-400">They appear to be innocent.</p>
                    `}
                    <button type="button" id="back-to-dashboard" class="mt-8 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg w-full md:w-1/2 text-xl mx-auto block">
                        Back to Dashboard
                    </button>
                </div>
            `,

        revealedTeammates: ({ role, teammates }) => `
            <div class="bg-gray-900 p-5 rounded-lg mt-4">
                <h2 class="text-2xl font-semibold text-cyan-400 mb-4">Your ${role} Team</h2>
                ${teammates.length > 0 ? `
                <ul class="list-disc list-inside space-y-2">
                    ${teammates.map(name => `<li>${name}</li>`).join('')}
                </ul>
                ` : '<p class="text-gray-400">You have not revealed any teammates yet.</p>'}
                <button type="button" id="back-to-dashboard" class="mt-6 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg w-full">Back to Dashboard</button>
            </div>`,
    };

    function renderView(viewName, data = {}) {
        if (viewName === 'login') {
            appRoot.innerHTML = templates.login();
        } else {
            appRoot.innerHTML = templates.gameLayout(templates[viewName](data));
        }
    }

async function handleLogin() {
Â  Â  Â  Â  const passcodeInput = document.getElementById('passcode-input').value.trim(); // Only get passcode
Â  Â  Â  Â  const loginError = document.getElementById('login-error');
Â  Â  Â  Â  if (!passcodeInput) { // Only check passcode input
            loginError.textContent = 'Please enter your passcode.';
            return;
        }

Â  Â  Â  Â  loginError.textContent = '';
Â  Â  Â  Â  loadingOverlay.style.display = 'flex';
Â  Â  Â  Â  
Â  Â  Â  Â  await fetchPlayers(); // This fetches all players, including their passcodes

Â  Â  Â  Â  if (state.allPlayers.length === 0) {
Â  Â  Â  Â  Â  Â  loadingOverlay.style.display = 'none';
Â  Â  Â  Â  Â  Â  loginError.textContent = 'Could not load player list from the server. Check Netlify function logs.';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Find the player by passcode only
Â  Â  Â  Â  const player = state.allPlayers.find(p => 
            p.Passcode && p.Passcode.trim() === passcodeInput // Check passcode only
        );
Â  Â  Â  Â  
Â  Â  Â  Â  if (player) {
Â  Â  Â  Â  Â  Â  localStorage.setItem('mafiaGameUserId', player.PlayerID);
Â  Â  Â  Â  Â  Â  await initializeGame(player.PlayerID);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  loadingOverlay.style.display = 'none';
Â  Â  Â  Â  Â  Â  loginError.textContent = 'Invalid Passcode. Please try again.'; // Simplified error message
Â  Â  Â  Â  }
Â  Â  }

    async function fetchPlayers(forceRefresh = false) {
        if (state.allPlayers.length > 0 && !forceRefresh) return;
        try {
            const response = await fetch('/.netlify/functions/get-player-data');
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Fetch failed with status:', response.status, 'Response:', errorText);
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            state.allPlayers = await response.json();
        } catch (error) {
            console.error("Full error in fetchPlayers:", error);
            showMessage("Failed to load player data. Check console for details.");
            state.allPlayers = [];
        }
    }

async function initializeGame(userId) {
Â  Â  Â  Â  state.currentUserId = userId;
Â  Â  Â  Â  state.currentUser = state.allPlayers.find(p => p.PlayerID === userId);
Â  Â  Â  Â  if (!state.currentUser) {
Â  Â  Â  Â  Â  Â  localStorage.removeItem('mafiaGameUserId');
Â  Â  Â  Â  Â  Â  renderView('login');
Â  Â  Â  Â  Â  Â  document.getElementById('login-error').textContent = "Your player data seems outdated. Please log in again.";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
        state.isCurrentUserAdmin = state.currentUser.IsAdmin === 'TRUE';
        await fetchGameState();

        // NEW: Fetch current player's mission
        loadingOverlay.style.display = 'flex'; // Show loading while fetching mission
        try {
            const missionResponse = await fetch(`/.netlify/functions/get-player-mission?playerId=${state.currentUserId}`);
            if (missionResponse.ok) {
                const missionResult = await missionResponse.json();
                state.currentMission = missionResult.currentMission;
            } else {
                console.error("Error fetching player mission:", await missionResponse.text());
                state.currentMission = null; // Ensure it's null on error
            }
        } catch (error) {
            console.error("Error fetching player mission:", error);
            state.currentMission = null;
        } finally {
            loadingOverlay.style.display = 'none'; // Hide loading after mission fetch
        }

// Check if the current user is dead
            if (state.currentUser.Status && state.currentUser.Status.toLowerCase() === 'dead') {
                renderView('deadPage'); // Show the dead page
            } else {
                // If alive, render dashboard and fetch recap if it's Day
                renderView('dashboard');
                updateDashboardActions(state.gameState?.CurrentPhase || 'Day'); // This will render action buttons

                // NEW: Fetch nightly recap if it's Day phase
                if (state.gameState?.CurrentPhase === 'Day') {
                    const previousDay = parseInt(state.gameState.CurrentDay) - 1;
                    if (previousDay >= 1) { // Only fetch recap if it's not Day 1
                        loadingOverlay.style.display = 'flex'; // Show loading for recap fetch
                        try {
                            const recapResponse = await fetch(`/.netlify/functions/get-nightly-recap?dayNumber=${previousDay}`);
                            if (recapResponse.ok) {
                                const recapResult = await recapResponse.json();
                                state.nightlyRecap = recapResult.recapData;
                                // After state is updated, re-render the dashboard to show the recap
                                // This might cause a slight flicker, but ensures recap is displayed.
                                renderView('dashboard'); // Re-render to display recap
                                updateDashboardActions(state.gameState?.CurrentPhase || 'Day'); // Re-render actions too
                            } else {
                                console.error("Error fetching nightly recap:", await recapResponse.text());
                                state.nightlyRecap = null;
                            }
                        } catch (error) {
                            console.error("Error fetching nightly recap:", error);
                            state.nightlyRecap = null;
                        } finally {
                            loadingOverlay.style.display = 'none';
                        }
                    }
                }
            }
Â  Â  }

    function getPlayerNameById(playerId) {
        const player = state.allPlayers.find(p => p.PlayerID === playerId);
        return player ? player.Name : 'N/A';
    }

    async function fetchGameState() {
        try {
            const response = await fetch('/.netlify/functions/get-game-state');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            state.gameState = await response.json();
        } catch (error) {
            console.error("Error fetching game state:", error);
            showMessage("Failed to load game state.");
            state.gameState = null;
        }
    }
    
    function showMessage(message) {
        messageBox.textContent = message;
        messageBox.style.display = 'block';
    }

    async function performFetchAction(endpoint, payload) {
        loadingOverlay.style.display = 'flex';
        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });

            const result = await response.json();

            if (response.ok) {
                showMessage(result.message || 'Action performed successfully!');
                await fetchPlayers(true);
                await fetchGameState();
                initializeGame(state.currentUserId);
            } else {
                throw new Error(result.message || `Error: ${response.status} ${response.statusText}`);
            }
        } catch (error) {
            console.error("Error performing action:", error);
            showMessage(`Failed to perform action: ${error.message}`);
        } finally {
            loadingOverlay.style.display = 'none';
            setTimeout(() => { messageBox.style.display = 'none'; }, 5000);
        }
    }

// --- Audio Recording Functions ---
    async function startRecording() {
        console.log("Attempting to start recording...");
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            let options = null; // Declare options here
            let selectedMimeType = null; // Store the selected MIME type

            const possibleMimeTypes = [
                'audio/wav', // Highest priority for universal playback
                'audio/mp4', // Next priority, common for iOS but codec can vary
                'audio/webm;codecs=opus', // Standard WebM (Opus codec)
                'audio/webm' // Generic WebM (might use different codec)
            ];

            console.log("startRecording: Checking supported MIME types...");
            for (const mimeType of possibleMimeTypes) {
                const isSupported = MediaRecorder.isTypeSupported(mimeType);
                console.log(`startRecording: ${mimeType} support: ${isSupported}`);
                if (isSupported) {
                    options = { mimeType: mimeType };
                    selectedMimeType = mimeType; // Store the actual selected MIME type
                    break;
                }
            }

            if (!options) {
                console.error('startRecording: No supported audio mimeType found for MediaRecorder.');
                showMessage('Your browser does not support recording audio in any known format.');
                stream.getTracks().forEach(track => track.stop());
                return;
            }
            
            mediaRecorder = new MediaRecorder(stream, options);
            console.log(`startRecording: MediaRecorder initialized with mimeType: ${options.mimeType}`);

            audioChunks = [];
            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                // IMPORTANT: Use the selectedMimeType for the Blob
                recordedAudioBlob = new Blob(audioChunks, { type: selectedMimeType });
                audioPlayer = document.getElementById('audio-playback');
                audioPlayer.src = URL.createObjectURL(recordedAudioBlob);
                audioPlayer.load();

                document.getElementById('audio-playback').classList.remove('hidden');
                document.getElementById('submit-accusation-btn').disabled = false;

                stream.getTracks().forEach(track => track.stop());
            };

            mediaRecorder.start();
            document.getElementById('start-recording').disabled = true;
            document.getElementById('stop-recording').disabled = false;
            document.getElementById('submit-accusation-btn').disabled = true;
            document.getElementById('audio-playback').classList.add('hidden');
            showMessage('Recording started...');
        } catch (err) {
            console.error('Error accessing microphone:', err);
            if (err.name === 'NotAllowedError') {
                showMessage('Microphone access denied. Please allow microphone access in your browser settings.');
            } else if (err.name === 'NotFoundError') {
                showMessage('No microphone found. Please ensure a microphone is connected.');
            } else {
                showMessage('Could not access microphone: ' + err.message);
            }
        }
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            document.getElementById('start-recording').disabled = false;
            document.getElementById('stop-recording').disabled = true;
            showMessage('Recording stopped. Preview available.');
        }
    }

// --- Accusation Form Submission Function ---
    async function submitAccusation(accusedPlayerId, audioBlob) {
        if (!accusedPlayerId) {
            showMessage("Please select an accused player.");
            return;
        }
        if (!audioBlob) {
            showMessage("Please record an audio accusation first.");
            return;
        }

        loadingOverlay.style.display = 'flex';
        try {
            const formData = new FormData();
            formData.append('accuserPlayerId', state.currentUserId);
            formData.append('accusedPlayerId', accusedPlayerId);

            // This is the block you asked about, and it IS needed here in index.html
            let fileExtension = 'bin'; // Default fallback if type is unknown
            if (audioBlob && audioBlob.type) {
                if (audioBlob.type.includes('mp4')) {
                    fileExtension = 'mp4';
                } else if (audioBlob.type.includes('wav')) {
                    fileExtension = 'wav';
                } else if (audioBlob.type.includes('webm')) {
                    fileExtension = 'webm';
                }
            }
            formData.append('audioFile', audioBlob, `accusation_${state.currentUserId}_${Date.now()}.${fileExtension}`);
            // End of the block you asked about

            const response = await fetch('/.netlify/functions/submit-accusation', {
                method: 'POST',
                body: formData,
            });

            const result = await response.json();

            if (response.ok) {
                showMessage(result.message || 'Accusation submitted successfully!');
                await fetchPlayers(true);
                await fetchGameState();
                initializeGame(state.currentUserId);
            } else {
                throw new Error(result.message || `Error: ${response.status} ${response.statusText}`);
            }
        } catch (error) {
            console.error("Error submitting accusation:", error);
            showMessage(`Failed to submit accusation: ${error.message}`);
        } finally {
            loadingOverlay.style.display = 'none';
            setTimeout(() => { messageBox.style.display = 'none'; }, 5000);
            mediaRecorder = null;
            audioChunks = [];
            recordedAudioBlob = null;
            if (audioPlayer) audioPlayer.src = '';
        }
    }

    // --- Admin Review Functions ---
    async function fetchPendingAccusations() {
        loadingOverlay.style.display = 'flex';
        try {
            const response = await fetch('/.netlify/functions/get-pending-accusations');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            state.pendingAccusations = await response.json();
        } catch (error) {
            console.error("Error fetching pending accusations:", error);
            showMessage("Failed to load pending accusations.");
            state.pendingAccusations = [];
        } finally {
            loadingOverlay.style.display = 'none';
        }
    }

    async function handleApproveAccusation(accusationId) {
        await performFetchAction('/.netlify/functions/approve-accusation', { accusationId, adminPlayerId: state.currentUserId });
        await fetchPendingAccusations();
        renderView('adminReview', { pendingAccusations: state.pendingAccusations });
    }

    async function handleDenyAccusation(accusationId) {
        await performFetchAction('/.netlify/functions/deny-accusation', { accusationId, adminPlayerId: state.currentUserId });
        await fetchPendingAccusations();
        renderView('adminReview', { pendingAccusations: state.pendingAccusations });
    }
      
    // --- Trial Functions ---
// --- Trial Functions ---
async function fetchCurrentTrial() {
    loadingOverlay.style.display = 'flex';
    try {
        // 1. Fetch all active trials
        const allTrialsResponse = await fetch('/.netlify/functions/get-current-trial'); // This now returns ALL active trials
        if (!allTrialsResponse.ok) throw new Error(`HTTP error! status: ${allTrialsResponse.status}`);
        const allTrialsResult = await allTrialsResponse.json();
        const allActiveTrials = allTrialsResult.activeTrials || [];
        console.log(`fetchCurrentTrial: Found ${allActiveTrials.length} active trials.`);

        if (allActiveTrials.length === 0) {
            state.currentTrial = null;
            showMessage('No active trials found at this time.');
            return;
        }

        // 2. Fetch user's past votes
        const userVotesResponse = await fetch(`/.netlify/functions/get-user-trial-votes?voterPlayerId=${state.currentUserId}`);
        if (!userVotesResponse.ok) throw new Error(`HTTP error! status: ${userVotesResponse.status}`);
        const userVotesResult = await userVotesResponse.json();
        const votedTrialIds = new Set(userVotesResult.userVotes.map(vote => vote.TrialID));
        console.log(`fetchCurrentTrial: User has voted on ${votedTrialIds.size} trials.`);

        // 3. Find the first active trial the user has NOT voted on
        let nextTrial = null;
        for (const trial of allActiveTrials) {
            if (!votedTrialIds.has(trial.TrialID)) {
                nextTrial = trial;
                break; // Found the next unvoted trial
            }
        }

        state.currentTrial = nextTrial; // Store the next trial or null

        if (!state.currentTrial) {
            showMessage('You have voted on all active trials! Returning to dashboard.');
        }

    } catch (error) {
        console.error("Error fetching current trial or user votes:", error);
        showMessage("Failed to load trial data or user votes.");
        state.currentTrial = null;
    } finally {
        loadingOverlay.style.display = 'none';
    }
}

    function updateDashboardActions(currentPhase) {
        const playerActions = document.getElementById('player-dashboard-actions');
        if (!playerActions) return;
        playerActions.innerHTML = ''; // Clear existing buttons

const recapStoryDiv = document.getElementById('nightly-recap-story');
        if (recapStoryDiv && state.nightlyRecap) {
            recapStoryDiv.innerHTML = generateNightlyRecapStory(state.nightlyRecap);
        }

        const isNight = currentPhase && currentPhase.toLowerCase() !== 'day';

        const createButton = (id, text, style, onClick) => {
            const button = document.createElement('button');
            button.id = id;
            button.textContent = text;
            button.className = `${style} text-white font-bold py-3 px-6 rounded-lg transition`;
            button.onclick = onClick;
            playerActions.appendChild(button);
        };

// --- Nightly Recap Story Generation ---
function generateNightlyRecapStory(recapData) {
    if (!recapData) {
        return '<p class="text-gray-400">No events recorded last night.</p>';
    }

    const storyParts = [];

    // Helper for joining names with purple color
    const formatNames = (names) => {
        if (names.length === 0) return '';
        const coloredNames = names.map(name => `<span class="text-purple-400 font-bold">${name}</span>`); // Player names purple
        if (coloredNames.length === 1) return coloredNames[0];
        if (coloredNames.length === 2) return `${coloredNames[0]} and ${coloredNames[1]}`;
        return `${coloredNames.slice(0, -1).join(', ')}, and ${coloredNames[coloredNames.length - 1]}`;
    };

    // Get names for various events, now using formatNames directly
    const successfullyProtectedNames = recapData.mafiaProtected.map(id => getPlayerNameById(id));
    const mafiaKilledNames = recapData.mafiaKills.map(id => getPlayerNameById(id));
    const sheriffKilledNames = recapData.sheriffKills.map(id => getPlayerNameById(id));

    const guiltyAccusedNames = recapData.trialResults
        .filter(trial => trial.result === 'GUILTY')
        .map(trial => getPlayerNameById(trial.accusedPlayerId));

    const notGuiltyAccusedNames = recapData.trialResults
        .filter(trial => trial.result === 'NOT GUILTY')
        .map(trial => getPlayerNameById(trial.accusedPlayerId));

    // Opening
    storyParts.push(`As the first rays of dawn pierced through the darkness, <span class="font-bold text-gray-300">building 9</span> slowly awoke from a restless night.`);

    // Doctor Protections (only if they successfully protected someone from Mafia)
    if (successfullyProtectedNames.length > 0) {
        storyParts.push(`The <span class="text-blue-400 font-bold">Doctors</span> worked tirelessly, their healing touch safeguarding ${formatNames(successfullyProtectedNames)} from harm.`);
    } else {
        storyParts.push(`The <span class="text-blue-400 font-bold">Doctors</span> watched over the town, but their skills were either not needed or, sadly, not enough to prevent all tragedies.`);
    }

    // Mafia Kills
    if (mafiaKilledNames.length > 0) {
        storyParts.push(`But the chilling silence was broken by the grim news: the <span class="text-red-500 font-bold">Mafia</span> had claimed ${formatNames(mafiaKilledNames)}.`);
    } else if (successfullyProtectedNames.length > 0) { // If Mafia targeted but failed
         storyParts.push(`The <span class="text-red-500 font-bold">Mafia's</span> deadly aim was thwarted, as their targets managed to escape their grasp.`);
    } else {
        storyParts.push(`Remarkably, the <span class="text-red-500 font-bold">Mafia</span> seemed to have missed their mark, or perhaps, chose to lay low.`);
    }

    // Trial Results - GUILTY
    if (guiltyAccusedNames.length > 0) {
        storyParts.push(`In a tense moment, the trial${guiltyAccusedNames.length > 1 ? 's' : ''} of ${formatNames(guiltyAccusedNames)} concluded with a verdict of <span class="text-red-500 font-bold">GUILTY</span>. Justice, swift and final, was served.`);
    }

    // Trial Results - NOT GUILTY
    if (notGuiltyAccusedNames.length > 0) {
        storyParts.push(`The town deliberated over ${formatNames(notGuiltyAccusedNames)}'s fate, but the verdict came back <span class="text-green-500 font-bold">NOT GUILTY</span>. They walk free, for now.`);
    }

    // Sheriff Actions
    if (sheriffKilledNames.length > 0) {
        storyParts.push(`Amidst the chaos, the vigilant <span class="text-yellow-500 font-bold">Sheriff</span> exacted their own brand of justice, eliminating ${formatNames(sheriffKilledNames)}.`);
    } else {
        storyParts.push(`The <span class="text-yellow-500 font-bold">Sheriff's</span> gun remained silent, their target perhaps elusive or their moment yet to come.`);
    }

    // Closing - SRSI25 Cohort colored differently
    storyParts.push(`<span class="font-bold text-blue-400">SRSI25 Cohort</span> now faces a new day, with new questions and old suspicions lingering in the air.`); // Changed color to blue-400

    return storyParts.map(part => `<p>${part}</p>`).join('');
}
        const role = state.currentUser.Role.toLowerCase();

// --- ALL ROLES ---
        // Allow "Submit Accusation" only during the Day phase
        if (currentPhase.toLowerCase() === 'day') {
            createButton('btn-submit-accusation', 'Submit Accusation', 'bg-gray-700 hover:bg-gray-800', () => {
                const targets = state.allPlayers.filter(p =>
                    p.Status && typeof p.Status === 'string' && p.Status.toLowerCase() === 'alive' &&
                    p.PlayerID !== state.currentUserId
                );
                renderView('accusationForm', { targets });
            });
        }

// --- TRIAL BUTTON (for non-admins) ---
            if (!state.isCurrentUserAdmin) {
                createButton('btn-the-trial', 'The Trial', 'bg-purple-700 hover:bg-purple-800', async () => {
                    await fetchCurrentTrial(); // Fetch trial data before rendering
                    if (state.currentTrial) {
                        renderView('trialPage', { trial: state.currentTrial });
                    } else {
                        showMessage('No active trial found at this time.');
                    }
                });
            }

        // --- MAFIA ---
        if (role === 'mafia') {
            createButton('btn-kill', 'Kill Player', 'bg-red-700 hover:bg-red-800', () => {
                if (!isNight) return showMessage("You can only use this action at night.");
                if (state.currentUser.MainUsed === 'TRUE') return showMessage("You have already used your main action tonight.");
                const targets = state.allPlayers.filter(p =>
                    p.Status && typeof p.Status === 'string' && p.Status.toLowerCase() === 'alive' &&
                    p.Role && typeof p.Role === 'string' && p.Role.toLowerCase() !== 'mafia'
                );
                renderView('actionModal', { title: 'Choose a Target to Kill', buttonText: 'Confirm Kill', targets, actionType: 'kill' });
            });
            createButton('btn-convert', 'Convert Villager', 'bg-red-900', () => {
                if (!isNight) return showMessage("You can only use this ability at night.");
                if (state.currentUser.MafiaCanConvert !== 'TRUE') return showMessage("You have not unlocked this ability or have already used it.");
                performFetchAction('/.netlify/functions/convert-villager', { mafiaPlayerId: state.currentUserId });
            });
            createButton('btn-reveal-mafia', 'Reveal Mafia', 'bg-red-900', () => {
                if (!isNight) return showMessage("You can only use this ability at night.");
                if (state.currentUser.MafiaCanRevealSelf !== 'TRUE') return showMessage("You have not unlocked this ability or have already used it.");
                performFetchAction('/.netlify/functions/reveal-mafia', { mafiaPlayerId: state.currentUserId });
            });
            createButton('btn-view-teammates', 'List Mafia', 'bg-cyan-600 hover:bg-cyan-700', () => {
                if (!state.currentUser.RevealedTeammates) return showMessage("You have not revealed any teammates yet.");
                const teammates = state.currentUser.RevealedTeammates.split(',').map(id => getPlayerNameById(id));
                renderView('revealedTeammates', { role: 'Mafia', teammates });
            });
        }

        // --- DOCTOR ---
        if (role === 'doctor') {
            createButton('btn-protect', 'Protect Player', 'bg-blue-700 hover:bg-blue-800', () => {
                if (!isNight) return showMessage("You can only use this action at night.");
                if (state.currentUser.MainUsed === 'TRUE') return showMessage("You have already used your main action tonight.");
                const targets = state.allPlayers.filter(p => p.Status && typeof p.Status === 'string' && p.Status.toLowerCase() === 'alive');
                renderView('actionModal', { title: 'Choose a Player to Protect', buttonText: 'Confirm Protection', targets, actionType: 'protect' });
            });
            createButton('btn-revive', 'Revive Player', 'bg-blue-900', () => {
                if (!isNight) return showMessage("You can only use this ability at night.");
                if (state.currentUser.DoctorCanRevive !== 'TRUE') return showMessage("You have not unlocked this ability or have already used it.");
                performFetchAction('/.netlify/functions/revive-player', { doctorPlayerId: state.currentUserId });
            });
            createButton('btn-reveal-doctor', 'Reveal Doctor', 'bg-blue-900', () => {
                if (!isNight) return showMessage("You can only use this ability at night.");
                if (state.currentUser.DoctorCanRevealSelf !== 'TRUE') return showMessage("You have not unlocked this ability or have already used it.");
                performFetchAction('/.netlify/functions/reveal-doctor', { doctorPlayerId: state.currentUserId });
            });
            createButton('btn-view-teammates', 'List Doctors', 'bg-cyan-600 hover:bg-cyan-700', () => {
                if (!state.currentUser.RevealedTeammates) return showMessage("You have not revealed any teammates yet.");
                const teammates = state.currentUser.RevealedTeammates.split(',').map(id => getPlayerNameById(id));
                renderView('revealedTeammates', { role: 'Doctor', teammates });
            });
        }

        // --- DETECTIVE ---
        if (role === 'detective') {
createButton('btn-check', 'Investigate Player', 'bg-yellow-600 hover:bg-yellow-700', async () => {
                if (!isNight) return showMessage("You can only use this action at night.");
                if (state.currentUser.MainUsed === 'TRUE') return showMessage("You have already used your main action tonight.");
                const targets = state.allPlayers.filter(p =>
                    p.Status && typeof p.Status === 'string' && p.Status.toLowerCase() === 'alive' &&
                    p.PlayerID !== state.currentUserId
                );
                // CRITICAL CHANGE: Modify actionModal submission to directly handle investigation result
                renderView('actionModal', {
                    title: 'Choose a Player to Investigate',
                    buttonText: 'Confirm Investigation',
                    targets,
                    actionType: 'check-and-display-result' // NEW actionType to differentiate
                });
            });
            createButton('btn-reveal-detective', 'Reveal a Detective', 'bg-yellow-900', () => showMessage("This ability is not yet implemented."));
createButton('btn-view-history', 'Investigation History', 'bg-purple-700 hover:bg-purple-800', async () => {
                // Fetch the history for the current detective
                const response = await fetch(`/.netlify/functions/get-investigation-history?playerId=${state.currentUserId}`);
                if (!response.ok) {
                    showMessage("Failed to load investigation history.");
                    console.error("Error fetching investigation history:", await response.text());
                    return;
                }
                const result = await response.json();
                renderView('investigationHistory', { history: result.history });
            });        }

        // --- VILLAGER ---
        if (role === 'villager') {
            createButton('btn-increase-vote', 'Increase Vote Power', 'bg-green-900', () => {
                if (!isNight) return showMessage("You can only use this ability at night.");
                if (state.currentUser.VillagerCanIncreaseVote !== 'TRUE') return showMessage("You have not unlocked this ability or have already used it.");
                performFetchAction('/.netlify/functions/increase-vote-power', { villagerPlayerId: state.currentUserId });
            });
createButton('btn-change-role', 'Change Role', 'bg-green-900', () => {
                if (!isNight) return showMessage("You can only use this ability at night.");
                if (state.currentUser.VillagerCanChangeRole !== 'TRUE') return showMessage("You have not unlocked this ability or have already used it.");
                // CRITICAL CHANGE: Render the new modal for role selection
                renderView('changeRoleModal');
            });
        }

        // --- SHERIFF ---
        if (role === 'sheriff') {
            createButton('btn-shoot', 'Shoot Player', 'bg-gray-700 hover:bg-gray-800', () => {
                if (!isNight) return showMessage("You can only use this action at night.");
                if (state.currentUser.MainUsed === 'TRUE') return showMessage("You have already used your main action tonight.");
                if (state.currentUser.SheriffShotUsed === 'TRUE') return showMessage("You have already used your one-time shot.");
                const targets = state.allPlayers.filter(p =>
                    p.Status && typeof p.Status === 'string' && p.Status.toLowerCase() === 'alive' &&
                    p.PlayerID !== state.currentUserId
                );
                renderView('actionModal', { title: 'Choose Your Target', buttonText: 'Fire!', targets, actionType: 'shoot' });
            });
        }
    }

    window.onload = async () => {
        const savedUserId = localStorage.getItem('mafiaGameUserId');
        try {
            if (savedUserId) {
                loadingOverlay.style.display = 'flex';
                await fetchPlayers();
                if (state.allPlayers.length > 0) {
                    await initializeGame(savedUserId);
                } else {
                    localStorage.removeItem('mafiaGameUserId');
                    renderView('login');
                    document.getElementById('login-error').textContent = "Could not load player list from the server.";
                }
            } else {
                renderView('login');
            }
        } catch (error) {
            console.error("Critical error on page load:", error);
            renderView('login');
            document.getElementById('login-error').textContent = "An unexpected error occurred. Please try again.";
        } finally {
            loadingOverlay.style.display = 'none';
        }
    };

    appRoot.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (e.target.id === 'login-form') {
            handleLogin();
        } else if (e.target.id === 'action-form') {
            const actionType = e.target.dataset.actionType;
            const targetPlayerId = document.getElementById('target-player').value;

            if (!targetPlayerId) {
                showMessage("Please select a target player.");
                return;
            }

            let endpoint;
            let payload;

            switch (actionType) {
                case 'kill':
                    endpoint = '/.netlify/functions/kill-player';
                    payload = { mafiaPlayerId: state.currentUserId, targetPlayerId: targetPlayerId };
                    break;
                case 'protect':
                    endpoint = '/.netlify/functions/protect-player';
                    payload = { doctorPlayerId: state.currentUserId, targetPlayerId: targetPlayerId };
                    break;
                case 'check':
                    endpoint = '/.netlify/functions/check-mafia';
                    payload = { detectivePlayerId: state.currentUserId, targetPlayerId: targetPlayerId };
                    break;
                case 'shoot':
                    endpoint = '/.netlify/functions/shoot-player';
                    payload = { sheriffPlayerId: state.currentUserId, targetPlayerId: targetPlayerId };
                    break;
                    case 'check-and-display-result': // NEW CASE for Investigation
                    endpoint = '/.netlify/functions/check-mafia';
                    payload = { detectivePlayerId: state.currentUserId, targetPlayerId: targetPlayerId };
                    
                    loadingOverlay.style.display = 'flex'; // Show loading for this specific action
                    try {
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                        });
                        const result = await response.json();

                        if (response.ok) {
                            // Instead of showMessage, render the new template
                            const targetName = getPlayerNameById(targetPlayerId);
                            renderView('investigationResult', { targetName: targetName, isMafiaResult: result.isMafiaResult });
                            // No automatic return to dashboard here, user clicks "Back to Dashboard"
                        } else {
                            throw new Error(result.message || `Error: ${response.status} ${response.statusText}`);
                        }
                    } catch (error) {
                        console.error("Error performing investigation:", error);
                        showMessage(`Failed to perform investigation: ${error.message}`);
                        renderView('dashboard'); // Return to dashboard on error
                    } finally {
                        loadingOverlay.style.display = 'none';
                        setTimeout(() => { messageBox.style.display = 'none'; }, 5000); // Still hide message box if used
                    }
                    return; // IMPORTANT: Return here to prevent falling through to generic performFetchAction
                default:
                    showMessage('Unknown action type for submission.');
                    console.error('Unknown actionType:', actionType);
                    return;
            }

            if (endpoint) {
                await performFetchAction(endpoint, payload);
                renderView('dashboard');
            }
        } else if (e.target.id === 'accusation-submission-form') {
            await submitAccusation(document.getElementById('accused-player-select').value, recordedAudioBlob);
        }
    });

appRoot.addEventListener('click', async (e) => {
        if (e.target.id === 'back-to-dashboard') {
            renderView('dashboard');
        } else if (e.target.id === 'start-recording') {
            await startRecording();
        } else if (e.target.id === 'stop-recording') {
            stopRecording();
        } else if (e.target.id === 'btn-review-accusations') {
            await fetchPendingAccusations();
            renderView('adminReview', { pendingAccusations: state.pendingAccusations });
        } else if (e.target.classList.contains('btn-approve-accusation')) {
            const accusationId = e.target.dataset.accusationId;
            if (accusationId) {
                await handleApproveAccusation(accusationId);
            }
        } else if (e.target.classList.contains('btn-deny-accusation')) {
            const accusationId = e.target.dataset.accusationId;
            if (accusationId) {
                await handleDenyAccusation(accusationId);
            }
        } else if (e.target.classList.contains('btn-select-new-role')) { // Handle role selection
            const newRole = e.target.dataset.newRole;
            if (newRole) {
                await performFetchAction('/.netlify/functions/change-role', { villagerPlayerId: state.currentUserId, newRole: newRole });
                renderView('dashboard'); // Return to dashboard after role change
            } else {
                showMessage('No role selected.');
            }
        } else if (e.target.id === 'btn-vote-guilty') { // GUILTY vote button
            const trialId = e.target.dataset.trialId;
            const votingPower = state.currentUser.CurrentVotingPower;
            if (trialId && votingPower !== undefined) {
                await performFetchAction('/.netlify/functions/submit-jury-vote', { trialId, voterPlayerId: state.currentUserId, voteType: 'GUILTY', votingPower });
                // After voting, try to load the next trial
                await fetchCurrentTrial();
                if (state.currentTrial) {
                    renderView('trialPage', { trial: state.currentTrial }); // Show next trial
                } else {
                    renderView('dashboard'); // No more trials, go to dashboard
                }
            } else {
                showMessage('Missing trial ID or voting power to submit vote.');
            }
        } else if (e.target.id === 'btn-vote-not-guilty') { // NOT GUILTY vote button
            const trialId = e.target.dataset.trialId;
            const votingPower = state.currentUser.CurrentVotingPower;
            if (trialId && votingPower !== undefined) {
                await performFetchAction('/.netlify/functions/submit-jury-vote', { trialId, voterPlayerId: state.currentUserId, voteType: 'NOTGUILTY', votingPower });
                // After voting, try to load the next trial
                await fetchCurrentTrial();
                if (state.currentTrial) {
                    renderView('trialPage', { trial: state.currentTrial }); // Show next trial
                } else {
                    renderView('dashboard'); // No more trials, go to dashboard
                }
            } else {
                showMessage('Missing trial ID or voting power to submit vote.');
            }
        } else if (e.target.id === 'logout-button') { // Logout button (from dead page)
            localStorage.removeItem('mafiaGameUserId'); // Clear saved user ID
            state.currentUserId = null;
            state.currentUser = null;
            state.isCurrentUserAdmin = false;
            state.gameState = null;
            state.pendingAccusations = [];
            state.currentTrial = null;
            renderView('login'); // Go back to login page
            showMessage('You have been logged out.');
        }
    });
</script>
</body>
</html>