<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SRSI Mafia</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ... All previous styles unchanged ... */
  </style>
</head>
<body>
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    Loading SRSI Mafia...
  </div>

  <div id="app-root"></div>
  <div id="message-box" class="message-box"></div>

  <script type="module">
    const state = {
      allPlayers: [],
      currentUserId: null,
      currentUser: null,
      isCurrentUserAdmin: false,
      gameState: null
    };
    const appRoot = document.getElementById('app-root');
    const messageBox = document.getElementById('message-box');
    const loadingOverlay = document.getElementById('loading-overlay');

    const templates = {
      login: () => `
        <form id="login-form" class="flex flex-col items-center gap-4">
          <input id="login-code" placeholder="Enter your name" class="px-4 py-2 rounded w-full max-w-md" />
          <button class="bg-red-600 px-4 py-2 rounded hover:bg-red-700">Login</button>
          <div id="login-error" class="text-red-400 mt-2 text-sm"></div>
        </form>
      `,
      gameLayout: (viewHtml) => `
        <div>
          <h1 class="text-xl mb-4">Welcome to the game</h1>
          ${viewHtml}
        </div>
      `
    };

    function renderView(viewName, data = {}) {
      if (viewName === 'login') {
        appRoot.innerHTML = templates.login();
      } else {
        appRoot.innerHTML = templates.gameLayout(templates[viewName](data));
      }
      attachEventListeners(viewName);
    }

    function attachEventListeners(viewName) {
      if (viewName === 'login') {
        document.getElementById('login-form').addEventListener('submit', handleLogin);
      }
    }

    function showMessage(msg) {
      messageBox.textContent = msg;
      messageBox.style.display = 'block';
      setTimeout(() => {
        messageBox.style.display = 'none';
      }, 3000);
    }

    async function handleLogin(e) {
      e.preventDefault();
      const nameInput = document.getElementById('login-code').value.trim();
      const loginError = document.getElementById('login-error');
      if (!nameInput) return;

      loginError.textContent = '';
      loadingOverlay.style.display = 'flex';

      await fetchPlayers();

      if (state.allPlayers.length === 0) {
        loadingOverlay.style.display = 'none';
        loginError.textContent = 'Could not load player list from the server. Check Netlify function logs.';
        return;
      }

      const player = state.allPlayers.find(p => p.Name && p.Name.trim().toLowerCase() === nameInput.toLowerCase());

      if (player) {
        localStorage.setItem('mafiaGameUserId', player.PlayerID);
        await initializeGame(player.PlayerID);
      } else {
        loadingOverlay.style.display = 'none';
        loginError.textContent = 'Invalid Player Name. Please try again.';
      }
    }

    async function fetchPlayers(forceRefresh = false) {
      if (state.allPlayers.length > 0 && !forceRefresh) return;

      const baseUrl = window.location.hostname.includes('localhost')
        ? 'https://srsi25mafia.netlify.app'
        : '';

      try {
        const response = await fetch(`${baseUrl}/.netlify/functions/get-player-data`);
        const rawText = await response.clone().text();
        console.log("Raw response text:", rawText);

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const jsonData = await response.json();
        console.log("Parsed player data:", jsonData);

        state.allPlayers = jsonData;
      } catch (error) {
        console.error("fetchPlayers failed:", error);
        showMessage("Failed to load player data.");
        state.allPlayers = [];
      }
    }

    async function initializeGame(userId) {
      // Your existing logic
      loadingOverlay.style.display = 'none';
      renderView('game'); // placeholder for real game view
    }

    window.onload = async () => {
      const savedUserId = localStorage.getItem('mafiaGameUserId');
      if (savedUserId) {
        await initializeGame(savedUserId);
      } else {
        loadingOverlay.style.display = 'none';
        renderView('login');
      }
    };
  </script>
</body>
</html>
